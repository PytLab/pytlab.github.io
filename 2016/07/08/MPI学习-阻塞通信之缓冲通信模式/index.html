<!DOCTYPE HTML>
<html>
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <title>MPI学习--阻塞通信之缓冲通信模式 | PytLab</title>
  <meta name="author" content="PytLab">
  
  <meta name="description" content="通过一个缓冲通信的例子来简单总结下缓冲通信模式。">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="MPI学习--阻塞通信之缓冲通信模式"/>
  <meta property="og:site_name" content="PytLab"/>

  
    <meta property="og:image" content="undefined"/>
  

  
  
    <link href="/assets/images/favicon/icon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/bootstrap.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-73223373-1', 'auto');
  ga('send', 'pageview');
</script><!-- hexo-inject:begin --><!-- hexo-inject:end -->




</head>

 <body>  
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><nav id="main-nav" class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/"></a>
      <div class="collapse navbar-collapse nav-menu">
		    <ul class="nav navbar-nav">
		      

          <!-- Categories -->
          
          <li>
            <a href="/" title="PytLab's Home" style="font-weight: normal; font-family: Calibri,Arial; font-size: 18px">
              <i class="fa fa-bank"></i>Home
            </a>
          </li>
          
		      

          <!-- Categories -->
          
          <!-- Archives -->
          <li class="dropdown">
            <a href="/archives" class="dropdown-toggle" data-toggle="dropdown" title="All the articles." style="font-weight: normal; font-family: Calibri,Arial; font-size:     18px">
            <i class="fa fa-archive"></i>Archives
            <b class="caret"></b>   
            </a>
            <ul class="dropdown-menu">
              <li class="divider"></li>
              <li><a href="/archives" style="font-size: 20px; font-family: 'Calibri Light',Arial">All Archives</a><span></span></li>
              <li class="divider"></li>
              
              <li><a href="/2017/04/25/基于matplotlib写一个2D-3D抽象网格和能量曲线绘制程序/" style="font-size: 15px; font-family: 微软雅黑">基于matplotlib写一个2D/3D抽象网格和能量...<span></span></a></li>
              
              <li><a href="/2017/03/26/优雅的在终端中编写Python/" style="font-size: 15px; font-family: 微软雅黑">优雅的在终端中编写Python<span></span></a></li>
              
              <li><a href="/2017/02/19/Python多进程并行编程实践-mpi4py的使用/" style="font-size: 15px; font-family: 微软雅黑">Python多进程并行编程实践-mpi4py的使用<span></span></a></li>
              
              <li><a href="/2017/02/16/一本不错的MPI教程/" style="font-size: 15px; font-family: 微软雅黑">推荐一本不错的MPI教程<span></span></a></li>
              
              <li><a href="/2017/02/14/ECMAScript中的作用域链和闭包/" style="font-size: 15px; font-family: 微软雅黑">ECMAScript中的作用域链和闭包<span></span></a></li>
              
              <li><a href="/2017/02/08/ECMAScript中的OOP-继承/" style="font-size: 15px; font-family: 微软雅黑">ECMAScript中的OOP-继承<span></span></a></li>
              
              <li><a href="/2017/02/06/ECMAScript中的OOP-创建对象/" style="font-size: 15px; font-family: 微软雅黑">ECMAScript中的OOP-对象创建<span></span></a></li>
              
              <li class="divider"></li>
            </ul>
          </li>

          
		      

          <!-- Categories -->
          
		      <li class="dropdown">
            <a href="/categories" class="dropdown-toggle" data-toggle="dropdown" title="All the categories." style="font-weight: normal; font-family: Calibri,Arial; font-size:     18px">
		    	  <i class="fa fa-folder"></i>Categories
            <b class="caret"></b>   
		    	  </a>
            <ul class="dropdown-menu">
              <li class="divider"></li>
              <li><a href="/categories" style="font-size: 20px; font-family: 'Calibri Light',Arial">All Categories</a><span></span></li>
              <li class="divider"></li>
              
              <li><a href="/categories/学习小结/" style="font-size: 15px; font-family: 微软雅黑">学习小结<span></span></a></li>
              
              <li><a href="/categories/学术/" style="font-size: 15px; font-family: 微软雅黑">学术<span></span></a></li>
              
              <li><a href="/categories/代码作品/" style="font-size: 15px; font-family: 微软雅黑">代码作品<span></span></a></li>
              
              <li><a href="/categories/教程/" style="font-size: 15px; font-family: 微软雅黑">教程<span></span></a></li>
              
              <li><a href="/categories/我的日常/" style="font-size: 15px; font-family: 微软雅黑">我的日常<span></span></a></li>
              
              <li><a href="/categories/随笔/" style="font-size: 15px; font-family: 微软雅黑">随笔<span></span></a></li>
              
              <li><a href="/categories/工具应用/" style="font-size: 15px; font-family: 微软雅黑">工具应用<span></span></a></li>
              
              <li class="divider"></li>
            </ul>
		      </li>

          
		      

          <!-- Categories -->
          
          <!-- Tags -->
          <li class="dropdown">
            <a href="/tags" class="dropdown-toggle" data-toggle="dropdown" title="All the tags." style="font-weight: normal; font-family: Calibri,Arial; font-size:     18px">
            <i class="fa fa-tags"></i>Tags
            <b class="caret"></b>   
            </a>
            <ul class="dropdown-menu">
              <li class="divider"></li>
              <li><a href="/tags" style="font-size: 20px; font-family: 'Calibri Light',Arial">All Tags</a><span></span></li>
              <li class="divider"></li>
              
              <li><a href="/tags/Cpp/" style="font-size: 15px; font-family: 微软雅黑">Cpp<span></span></a></li>
              
              <li><a href="/tags/python/" style="font-size: 15px; font-family: 微软雅黑">python<span></span></a></li>
              
              <li><a href="/tags/catalysis/" style="font-size: 15px; font-family: 微软雅黑">catalysis<span></span></a></li>
              
              <li><a href="/tags/C/" style="font-size: 15px; font-family: 微软雅黑">C<span></span></a></li>
              
              <li><a href="/tags/chemistry/" style="font-size: 15px; font-family: 微软雅黑">chemistry<span></span></a></li>
              
              <li><a href="/tags/Parallel-Computing/" style="font-size: 15px; font-family: 微软雅黑">Parallel Computing<span></span></a></li>
              
              <li><a href="/tags/学术/" style="font-size: 15px; font-family: 微软雅黑">学术<span></span></a></li>
              
              <li class="divider"></li>
            </ul>
          </li>
          
          
		      

          <!-- Categories -->
          
          <li>
            <a href="/about" title="About me." style="font-weight: normal; font-family: Calibri,Arial; font-size: 18px">
              <i class="fa fa-user"></i>About
            </a>
          </li>
          
		      
		    </ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">		
			<h1> MPI学习--阻塞通信之缓冲通信模式</h1>
		</div>		
	



<div class="row post">
	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  
		 <div class="alert alert-success description">
			<i class="fa fa-info-circle"></i> <p>通过一个缓冲通信的例子来简单总结下缓冲通信模式。</p>
			
		 </div> <!-- alert -->
	  		

	  <p>缓冲通信模式主要用于解开阻塞通信的发送和接受之间的耦合。有了缓冲机制，即使在接收端没有启动相应的接收情况下，在<strong>完成消息数据到缓冲区的转移后</strong>发送端的阻塞发送函数也可以返回。</p>
<p>但缓冲方式带来了额外的内存到内存的复制开销，会导致一定的性能损失和资源占用。的确，每个进程都要在堆里分配内存然后注册成为缓冲区。</p>
<p>缓冲区的使用并不能改变发送和接受之间的语义关系，及不能改变程序的正确性。</p>
<p>与标准模式由于以来MPI环境提供的缓冲机制而受到远端进程状态左右不同，缓冲发送完成与否不会受远端匹配进程状态的影响。但当消息大小超过缓冲区容量时，会报错。</p>
<a id="more"></a>
<p>缓冲通信模式如下图所示，<br><img src="/assets/images/blog_img/2016-07-08-MPI学习-阻塞通信之缓冲通信模式/buffer_recv.gif" alt=""></p>
<p>然后就写了个缓冲通信的例子来实际操作下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"mpi.h"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MSG1LEN 7</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MSG2LEN 2</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MSG3LEN 17</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> RMSG1LEN 64</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> RMSG2LEN 64</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> RMSG3LEN 64</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> ** argv)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// Communicator.</span></div><div class="line">    MPI_Comm comm = MPI_COMM_WORLD;</div><div class="line"></div><div class="line">    <span class="comment">// Process number.</span></div><div class="line">    <span class="keyword">int</span> src = <span class="number">0</span>, dest = <span class="number">1</span>;</div><div class="line"></div><div class="line">    <span class="comment">// Buffer sizes for 3 msg.</span></div><div class="line">    <span class="keyword">int</span> s1, s2, s3;</div><div class="line"></div><div class="line">    <span class="comment">// Buffers.</span></div><div class="line">    <span class="keyword">char</span> msg1[MSG1LEN], msg3[MSG2LEN], rmsg1[RMSG1LEN], rmsg3[MSG3LEN];</div><div class="line"></div><div class="line">    <span class="comment">// Buffers.</span></div><div class="line">    <span class="keyword">char</span> msg1[MSG1LEN], msg3[MSG2LEN], rmsg1[RMSG1LEN], rmsg3[MSG3LEN];</div><div class="line">    <span class="keyword">double</span> msg2[MSG2LEN], rmsg2[RMSG2LEN];</div><div class="line"></div><div class="line">    <span class="comment">// Buffer address.</span></div><div class="line">    <span class="keyword">char</span> * buf, * bbuf;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> errs = <span class="number">0</span>, rank, bufsize, bsize;</div><div class="line"></div><div class="line">    MPI_Init(&amp;argc, &amp;argv);</div><div class="line">    MPI_Comm_rank(comm, &amp;rank);</div><div class="line"></div><div class="line">    <span class="comment">// Create buffer for all messages.</span></div><div class="line">    MPI_Pack_size(MSG1LEN, MPI_CHAR, comm, &amp;s1);</div><div class="line">    MPI_Pack_size(MSG2LEN, MPI_DOUBLE, comm, &amp;s2);</div><div class="line">    MPI_Pack_size(MSG3LEN, MPI_CHAR, comm, &amp;s3);</div><div class="line"></div><div class="line">    <span class="comment">// Total buffer size.</span></div><div class="line">    bufsize = <span class="number">3</span>*MPI_BSEND_OVERHEAD + s1 + s2 + s3;</div><div class="line">    buf = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(bufsize);</div><div class="line">    MPI_Buffer_attach(buf, bufsize);</div><div class="line"></div><div class="line">    <span class="built_in">strncpy</span>(msg1, <span class="string">"012345"</span>, MSG1LEN);</div><div class="line">    <span class="built_in">strncpy</span>(msg3, <span class="string">"0123401234012341"</span>, MSG3LEN);</div><div class="line">    msg2[<span class="number">0</span>] = <span class="number">1.23</span>;</div><div class="line">    msg2[<span class="number">1</span>] = <span class="number">3.21</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (rank == src)</div><div class="line">    &#123;</div><div class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Before sending msg1 from proc %d, t = %f\n"</span>, rank, MPI_Wtime());</div><div class="line">        MPI_Bsend(msg1, MSG1LEN, MPI_CHAR, dest, <span class="number">1</span>, comm);</div><div class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"After sending msg1 from proc %d, t = %f\n"</span>, rank, MPI_Wtime());</div><div class="line"></div><div class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Before sending msg2 from proc %d, t = %f\n"</span>, rank, MPI_Wtime());</div><div class="line">        MPI_Bsend(msg2, MSG2LEN, MPI_DOUBLE, dest, <span class="number">1</span>, comm);</div><div class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"After sending msg2 from proc %d, t = %f\n"</span>, rank, MPI_Wtime());</div><div class="line"></div><div class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Before sending msg3 from proc %d, t = %f\n"</span>, rank, MPI_Wtime());</div><div class="line">        MPI_Bsend(msg3, MSG3LEN, MPI_CHAR, dest, <span class="number">1</span>, comm);</div><div class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"After sending msg3 from proc %d, t = %f\n"</span>, rank, MPI_Wtime());</div><div class="line"></div><div class="line">        MPI_Buffer_detach(&amp;buf, &amp;bufsize);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (rank == dest)</div><div class="line">    &#123;</div><div class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Before receiving  msg1 on proc %d, t = %f\n"</span>, rank, MPI_Wtime());</div><div class="line">        MPI_Recv(rmsg1, MSG1LEN, MPI_CHAR, src, <span class="number">1</span>, comm, MPI_STATUS_IGNORE);</div><div class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"After receiving  msg1 on proc %d, t = %f\n"</span>, rank, MPI_Wtime());</div><div class="line"></div><div class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Before receiving  msg2 on proc %d, t = %f\n"</span>, rank, MPI_Wtime());</div><div class="line">        MPI_Recv(rmsg2, MSG2LEN, MPI_DOUBLE, src, <span class="number">1</span>, comm, MPI_STATUS_IGNORE);</div><div class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"After receiving  msg2 on proc %d, t = %f\n"</span>, rank, MPI_Wtime());</div><div class="line"></div><div class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Before receiving  msg3 on proc %d, t = %f\n"</span>, rank, MPI_Wtime());</div><div class="line">        MPI_Recv(rmsg3, MSG3LEN, MPI_CHAR, src, <span class="number">1</span>, comm, MPI_STATUS_IGNORE);</div><div class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"After receiving  msg3 on proc %d, t = %f\n"</span>, rank, MPI_Wtime());</div><div class="line"></div><div class="line">        MPI_Buffer_detach(&amp;buf, &amp;bufsize);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(msg1, rmsg1) != <span class="number">0</span>)</div><div class="line">        &#123;</div><div class="line">            errs++;</div><div class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"message 1(%s) should be %s\n"</span>, rmsg1, msg1);</div><div class="line">            fflush(<span class="built_in">stderr</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (rmsg2[<span class="number">0</span>] != msg2[<span class="number">0</span>] || rmsg2[<span class="number">1</span>] != msg2[<span class="number">1</span>])</div><div class="line">        &#123;</div><div class="line">            errs++;</div><div class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,</div><div class="line">                    <span class="string">"message 2 incorrect, values are (%f, %f) but should be (%f, %f)\n"</span>,</div><div class="line">                    rmsg2[<span class="number">0</span>], rmsg2[<span class="number">1</span>], msg2[<span class="number">0</span>], msg2[<span class="number">1</span>]);</div><div class="line">            fflush(<span class="built_in">stderr</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(msg3, rmsg3) != <span class="number">0</span>) &#123;</div><div class="line">            errs++;</div><div class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"message 2(%s) should be %s\n"</span>, rmsg3, msg3);</div><div class="line">            fflush(<span class="built_in">stderr</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="built_in">free</span>(buf); </div><div class="line"></div><div class="line">    MPI_Finalize();</div><div class="line">            </div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面的代码有一些针对缓冲通信模式的新内容：</p>
<ul>
<li><p>获取每个消息所需缓冲区大小</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">MPI_Pack_size</span><span class="params">(<span class="keyword">int</span> incount,</span></span></div><div class="line">                  MPI_Datatype datatype,</div><div class="line">                  MPI_Comm comm,</div><div class="line">                  <span class="keyword">int</span> *size)</div></pre></td></tr></table></figure>
<p>  使用<code>PACK_SIZE</code>来为每个消息计算其使用buffer的大小。此函数用来返回打包一个消息所需要的最大上限，以字节为单位。</p>
</li>
<li><p>定义缓冲方式需要的总的内存开销上界</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">bufsize = <span class="number">3</span>*MPI_BSEND_OVERHEAD + s1 + s2 + s3;</div></pre></td></tr></table></figure>
<blockquote>
<p>The MPI_BSEND_OVERHEAD gives the maximum amount of space that may be used in the buffer for use by the BSEND routines in using the buffer. This value is in mpi.h (for C) and mpif.h (for Fortran).<br>  这样用户就可以自定义用于缓冲通信的缓冲区的大小。</p>
</blockquote>
</li>
<li><p>装配用于通信的缓冲区</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">MPI_Buffer_attach</span><span class="params">(<span class="keyword">void</span> *buffer, <span class="keyword">int</span> size)</span></span></div></pre></td></tr></table></figure>
<p>  此函数就将用户自己开辟的内存空间注册为一个用于缓冲通信的缓冲区。</p>
</li>
<li><p>移除一个当前存在的用于缓冲通信的缓冲区</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">MPI_Buffer_detach</span><span class="params">(<span class="keyword">void</span> *buffer_addr, <span class="keyword">int</span> *size)</span></span></div></pre></td></tr></table></figure>
<p>  这里需要注意的是第一个参数<code>void *buffer_addr</code>是个<strong>指针的指针</strong>，这与<code>MPI_Buffer_attach</code>中的参数并不相同<br>  但是这里的移除并不是释放该进程申请的内存，因此在最后还要将内存释放掉。</p>
</li>
</ul>
<p>将这个例子进行编译执行的结果：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[zjshao@master ch02]$ mpiexec -host node01 -n 2 bsendrecv.x</div><div class="line">Before receiving  msg1 on proc 1, t = 1467968222.659515</div><div class="line">Before sending msg1 from proc 0, t = 1467968222.659531</div><div class="line">After sending msg1 from proc 0, t = 1467968222.659563</div><div class="line">After receiving  msg1 on proc 1, t = 1467968222.659565</div><div class="line">Before receiving  msg2 on proc 1, t = 1467968222.659572</div><div class="line">Before sending msg2 from proc 0, t = 1467968222.659571</div><div class="line">After sending msg2 from proc 0, t = 1467968222.659592</div><div class="line">Before sending msg3 from proc 0, t = 1467968222.659599</div><div class="line">After receiving  msg2 on proc 1, t = 1467968222.659595</div><div class="line">Before receiving  msg3 on proc 1, t = 1467968222.659600</div><div class="line">After sending msg3 from proc 0, t = 1467968222.659616</div><div class="line">After receiving  msg3 on proc 1, t = 1467968222.659619</div><div class="line">[zjshao@master ch02]$</div></pre></td></tr></table></figure></p>
<p>为了能体现缓冲通信模式的特点，加几个阻塞函数在两个进程中：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (rank == src)</div><div class="line">&#123;</div><div class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Before sending msg1 from proc %d, t = %f\n"</span>, rank, MPI_Wtime());</div><div class="line">    MPI_Bsend(msg1, MSG1LEN, MPI_CHAR, dest, <span class="number">1</span>, comm);</div><div class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"After sending msg1 from proc %d, t = %f\n"</span>, rank, MPI_Wtime());</div><div class="line"></div><div class="line">    ...</div><div class="line"></div><div class="line">    MPI_Barrier(comm);</div><div class="line"></div><div class="line">    MPI_Buffer_detach(&amp;buf, &amp;bufsize);</div><div class="line">&#125;</div><div class="line"><span class="keyword">else</span> <span class="keyword">if</span> (rank == dest)</div><div class="line">&#123;</div><div class="line">    MPI_Barrier(comm);</div><div class="line"></div><div class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Before receiving  msg1 on proc %d, t = %f\n"</span>, rank, MPI_Wtime());</div><div class="line">    MPI_Recv(rmsg1, MSG1LEN, MPI_CHAR, src, <span class="number">1</span>, comm, MPI_STATUS_IGNORE);</div><div class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"After receiving  msg1 on proc %d, t = %f\n"</span>, rank, MPI_Wtime());</div><div class="line"></div><div class="line">    ...</div><div class="line"></div><div class="line">    MPI_Buffer_detach(&amp;buf, &amp;bufsize);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>重新编译执行：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">[zjshao@master ch02]$ mpicc bsendrecv.c -o bsendrecv.x</div><div class="line">[zjshao@master ch02]$ mpiexec -host node01 -n 2 bsendrecv.x</div><div class="line">Before sending msg1 from proc 0, t = 1467968941.629696</div><div class="line">After sending msg1 from proc 0, t = 1467968941.629726</div><div class="line">Before sending msg2 from proc 0, t = 1467968941.629733</div><div class="line">After sending msg2 from proc 0, t = 1467968941.629745</div><div class="line">Before sending msg3 from proc 0, t = 1467968941.629750</div><div class="line">After sending msg3 from proc 0, t = 1467968941.629769</div><div class="line">Before receiving  msg1 on proc 1, t = 1467968941.629784</div><div class="line">After receiving  msg1 on proc 1, t = 1467968941.629812</div><div class="line">Before receiving  msg2 on proc 1, t = 1467968941.629818</div><div class="line">After receiving  msg2 on proc 1, t = 1467968941.629823</div><div class="line">Before receiving  msg3 on proc 1, t = 1467968941.629827</div><div class="line">After receiving  msg3 on proc 1, t = 1467968941.629830</div><div class="line">[zjshao@master ch02]$</div></pre></td></tr></table></figure></p>
<p>可见，发送动作可以在执行后立即返回，MPI环境在底层完成了消息的传递，也就是发送动作将数据送达到接收端，进入接受缓冲区，然后返回就好了，接收端会在接受缓冲区中将数据解析完成接受操作。</p>
<p>现在我们把阻塞函数放到发送进程的detach之后：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (rank == src)</div><div class="line">&#123;</div><div class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Before sending msg1 from proc %d, t = %f\n"</span>, rank, MPI_Wtime());</div><div class="line">    MPI_Bsend(msg1, MSG1LEN, MPI_CHAR, dest, <span class="number">1</span>, comm);</div><div class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"After sending msg1 from proc %d, t = %f\n"</span>, rank, MPI_Wtime());</div><div class="line"></div><div class="line">    ...</div><div class="line"></div><div class="line">    MPI_Buffer_detach(&amp;buf, &amp;bufsize);</div><div class="line">    MPI_Barrier(comm);</div><div class="line">&#125;</div><div class="line"><span class="keyword">else</span> <span class="keyword">if</span> (rank == dest)</div><div class="line">&#123;</div><div class="line">    MPI_Barrier(comm);</div><div class="line"></div><div class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Before receiving  msg1 on proc %d, t = %f\n"</span>, rank, MPI_Wtime());</div><div class="line">    MPI_Recv(rmsg1, MSG1LEN, MPI_CHAR, src, <span class="number">1</span>, comm, MPI_STATUS_IGNORE);</div><div class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"After receiving  msg1 on proc %d, t = %f\n"</span>, rank, MPI_Wtime());</div><div class="line"></div><div class="line">    ...</div><div class="line"></div><div class="line">    MPI_Buffer_detach(&amp;buf, &amp;bufsize);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>执行结果遇上面相同，也就是说在释放发送端的缓冲区的时候消息一经发送完成，到了接收端的缓冲区中，因此这时候释放发送端缓冲区并不会有什么影响。</p>
<p>当然，如果在发送信息之前进行接受操作，而且在发送前设置阻塞函数，则就会发生死锁：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (rank == src)</div><div class="line">&#123;</div><div class="line">    MPI_Barrier(comm);</div><div class="line"></div><div class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Before sending msg1 from proc %d, t = %f\n"</span>, rank, MPI_Wtime());</div><div class="line">    MPI_Bsend(msg1, MSG1LEN, MPI_CHAR, dest, <span class="number">1</span>, comm);</div><div class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"After sending msg1 from proc %d, t = %f\n"</span>, rank, MPI_Wtime());</div><div class="line"></div><div class="line">    ...</div><div class="line"></div><div class="line">    MPI_Buffer_detach(&amp;buf, &amp;bufsize);</div><div class="line">&#125;</div><div class="line"><span class="keyword">else</span> <span class="keyword">if</span> (rank == dest)</div><div class="line">&#123;</div><div class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Before receiving  msg1 on proc %d, t = %f\n"</span>, rank, MPI_Wtime());</div><div class="line">    MPI_Recv(rmsg1, MSG1LEN, MPI_CHAR, src, <span class="number">1</span>, comm, MPI_STATUS_IGNORE);</div><div class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"After receiving  msg1 on proc %d, t = %f\n"</span>, rank, MPI_Wtime());</div><div class="line"></div><div class="line">    ...</div><div class="line"></div><div class="line">    MPI_Barrier(comm);</div><div class="line"></div><div class="line">    MPI_Buffer_detach(&amp;buf, &amp;bufsize);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>执行结果：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[zjshao@master ch02]$ mpicc bsendrecv.c -o bsendrecv.x</div><div class="line">[zjshao@master ch02]$ mpiexec -host node01 -n 2 bsendrecv.x</div><div class="line">Before receiving  msg1 on proc 1, t = 1467965050.882681</div><div class="line">[mpiexec@master.cluster] Sending Ctrl-C to processes as requested</div><div class="line">[mpiexec@master.cluster] Press Ctrl-C again to force abort</div></pre></td></tr></table></figure></p>
	  
	</div>

    
	<div>
  	<center>
	<div class="pagination">
<ul class="pagination">
	 
				
    	<li class="prev"><a href="/2016/07/08/MPI学习-阻塞通信之就绪通信模式和同步通信模式/" class="alignleft prev"><i class="fa fa-arrow-circle-o-left"></i>Prev</a></li>
  		

        <li><a href="/"><i class="fa fa-archive"></i>Archive</a></li>

		
		   <li class="next"><a href="/2016/07/07/MPI学习-阻塞通信之标准通信模式/" class="alignright next">Next<i class="fa fa-arrow-circle-o-right"></i></a></li>         
        
	
</ul>
</div>

    </center>
	</div>
    
	
    <!-- bdshare -->
    
        
    <div class="bdsharebuttonbox">
        <a href="#" class="bds_more" data-cmd="more"></a>
        <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a>
        <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
        <a href="#" class="bds_fbook" data-cmd="fbook" title="分享到Facebook"></a>
        <a href="#" class="bds_twi" data-cmd="twi" title="分享到Twitter"></a>
        <a href="#" class="bds_linkedin" data-cmd="linkedin" title="分享到linkedin"></a>
        <a href="#" class="bds_youdao" data-cmd="youdao" title="分享到有道云笔记"></a>
        <a href="#" class="bds_copy" data-cmd="copy" title="分享到复制网址"></a>
    </div>
    <script>
        window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"1","bdSize":"24"},"share":{}};
        with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
    </script>


        

    

	<!-- comment -->
    
<section id="comment">
  <h2 class="title">Comments</h2>

  
  	 <div class="ds-thread" data-thread-key="2016/07/08/MPI学习-阻塞通信之缓冲通信模式/" data-title="MPI学习--阻塞通信之缓冲通信模式" data-url="http://pytlab.github.io/2016/07/08/MPI学习-阻塞通信之缓冲通信模式/"></div>  
  
</section>

	</div> <!-- col-md-9/col-md-12 -->
		
	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2016-07-08 
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a href="/categories/学习小结/">学习小结<span class="badge">79</span></a></li>
  </li>

    </ul>
	</div>
	

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a href="/tags/MPI/">MPI<span class="badge">15</span></a></li> <li><a href="/tags/Parallel-Computing/">Parallel Computing<span class="badge">17</span></a></li>

    </ul>
	</div>
		

	<!-- toc -->
	<div class="meta-widget">
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

	</div>
		

</div><!-- row -->

<script type="text/javascript">
  var duoshuoQuery = { short_name: 'pytlab' };
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';
    ds.async = true;
    ds.src = 'http://static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script>



	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  
  &copy; copyright 2017 by <a href="http://pytlab.github.io"> PytLab </a>
  
      &nbsp; <a href="http://github.com/PytLab/hexo-theme-freemind/">Theme</a> by <a href="http://pytlab.github.io/">PytLab</a> based on <a href="https://github.com/wzpan/hexo-theme-freemind/">Freemind</a>.
</p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->



</body>
   </html>
